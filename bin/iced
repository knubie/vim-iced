#!/bin/bash

CWD=$(pwd)
SCRIPT_DIR=$(cd $(dirname $0); pwd)
PROJECT_DIR=$(cd $SCRIPT_DIR; cd ..; pwd)
VERSION=$(grep 'Version: ' ${SCRIPT_DIR}/../doc/vim-iced.txt | cut -d' ' -f2)

IS_LEININGEN=0
IS_BOOT=0
IS_CLOJURE_CLI=0
IS_SHADOW_CLJS=0

function iced_usage() {
    echo "vim-iced ${VERSION}"
    echo ""
    echo "Usage:"
    echo "  iced <task> [options]"
    echo ""
    echo "Following tasks are available:"
    echo "  repl      Start repl"
    echo "  help      Print this help"
    echo "  version   Print vim-iced version"
    echo ""
    echo "Use 'iced help <task>' or 'iced <task> --help' for more information."
    exit 1
}

function iced_repl_usage() {
    echo "Usage:"
    echo "  iced repl [options] [--with-cljs] [--force-boot] [--force-clojure-cli]"
    echo ""
    echo "Start repl. Leiningen, Boot, and Clojure CLI are supported."
    echo ""
    echo "The --with-cljs option enables ClojureScript features."
    echo "This option is enabled automatically when project configuration"
    echo "file(eg. project.clj) contains 'org.clojure/clojurescript' dependency."
    echo ""
    echo "On the other hand, the --without-cljs option disables ClojureScript features."
    echo ""
    echo "The --force-boot and --force-clojure-cli option enable you to start specified repl."
    echo ""
    echo "Other options are passed to each programs."
    echo "To specify Leiningen profile:"
    echo "  $ iced repl with-profile +foo"
    echo "To specify Clojure CLI alias:"
    echo "  $ iced repl -A:foo"
    echo "Combinating several options:"
    echo "  $ iced repl --with-cljs --force-clojure-cli -A:foo"
}

function echo_info() {
    echo -e "\x1B[32mOK\x1B[m: \x1B[1m${1}\x1B[m"
}

function echo_error() {
    echo -e "\x1B[31mNG\x1B[m: \x1B[1m${1}\x1B[m"
}

if [ $# -lt 1 ]; then
    iced_usage
    exit 1
fi

ARGV=($@)
ARGV=("${ARGV[@]:1}")

IS_HELP=0
IS_CLJS=0
FORCE_BOOT=0
FORCE_CLOJURE_CLI=0
DISABLE_CLJS_DETECTOR=0

OPTIONS=""
for x in ${ARGV[@]}; do
    if [ $x = '--help' ]; then
        IS_HELP=1
    elif [ $x = '--with-cljs' ]; then
        IS_CLJS=1
    elif [ $x = '--without-cljs' ]; then
        DISABLE_CLJS_DETECTOR=1
    elif [ $x = '--force-boot' ]; then
        FORCE_BOOT=1
    elif [ $x = '--force-clojure-cli' ]; then
        FORCE_CLOJURE_CLI=1
    else
        OPTIONS="${OPTIONS} ${x}"
    fi
done

IS_DETECTED=0
while :
do
    ls project.clj > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        IS_LEININGEN=1
        IS_DETECTED=1

        if [ $DISABLE_CLJS_DETECTOR -ne 1 ]; then
            grep org.clojure/clojurescript project.clj > /dev/null 2>&1
            if [ $? -eq 0 ]; then
                IS_CLJS=1
            fi
        fi
    fi

    ls build.boot > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        IS_BOOT=1
        IS_DETECTED=1

        if [ $DISABLE_CLJS_DETECTOR -ne 1 ]; then
            grep org.clojure/clojurescript build.boot > /dev/null 2>&1
            if [ $? -eq 0 ]; then
                IS_CLJS=1
            fi
        fi
    fi

    ls deps.edn > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        IS_CLOJURE_CLI=1
        IS_DETECTED=1

        if [ $DISABLE_CLJS_DETECTOR -ne 1 ]; then
            grep org.clojure/clojurescript deps.edn > /dev/null 2>&1
            if [ $? -eq 0 ]; then
                IS_CLJS=1
            fi
        fi
    fi

    ls shadow-cljs.edn > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        IS_SHADOW_CLJS=1
        IS_DETECTED=1
    fi

    if [ $IS_DETECTED -eq 1 ]; then
        break
    fi

    cd ..
    if [ $(pwd) == $CWD ]; then
        break
    else
        CWD=$(pwd)
    fi
done

if [ $FORCE_BOOT -eq 1 ]; then
    IS_LEININGEN=0
    IS_CLOJURE_CLI=0
elif [ $FORCE_CLOJURE_CLI -eq 1 ]; then
    IS_LEININGEN=0
    IS_BOOT=0
fi

case "$1" in
    "repl")
        if [ $IS_HELP -eq 1 ]; then
            iced_repl_usage
        elif [ $IS_LEININGEN -eq 1 ]; then
            echo_info "Leiningen project is detected"
            if [ $IS_CLJS -eq 0 ]; then
                lein update-in :dependencies conj '[nrepl "0.6.0"]' -- update-in :dependencies conj '[refactor-nrepl "2.4.0"]' -- update-in :dependencies conj '[cider/cider-nrepl "0.21.1"]' -- update-in :dependencies conj '[iced-nrepl "0.4.1"]' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-classpath' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-complete' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-debug' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-format' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-info' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-macroexpand' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-ns' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-out' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-spec' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-test' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-trace' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-undef' -- update-in :repl-options:nrepl-middleware conj 'refactor-nrepl.middleware/wrap-refactor' -- update-in :repl-options:nrepl-middleware conj 'iced.nrepl/wrap-iced' -- $OPTIONS repl
            else
                lein update-in :dependencies conj '[nrepl "0.6.0"]' -- update-in :dependencies conj '[refactor-nrepl "2.4.0"]' -- update-in :dependencies conj '[cider/cider-nrepl "0.21.1"]' -- update-in :dependencies conj '[iced-nrepl "0.4.1"]' -- update-in :dependencies conj '[cider/piggieback "0.4.0"]' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-classpath' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-complete' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-debug' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-format' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-info' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-macroexpand' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-ns' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-out' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-spec' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-test' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-trace' -- update-in :repl-options:nrepl-middleware conj 'cider.nrepl/wrap-undef' -- update-in :repl-options:nrepl-middleware conj 'refactor-nrepl.middleware/wrap-refactor' -- update-in :repl-options:nrepl-middleware conj 'iced.nrepl/wrap-iced' -- update-in :repl-options:nrepl-middleware conj 'cider.piggieback/wrap-cljs-repl' -- $OPTIONS repl
            fi
        elif [ $IS_BOOT -eq 1 ]; then
            echo_info "Boot project is detected"
            if [ $IS_CLJS -eq 0 ]; then
                boot -i "(require 'cider.tasks)" -d nrepl:0.6.0 -d refactor-nrepl:2.4.0 -d cider/cider-nrepl:0.21.1 -d iced-nrepl:0.4.1 -- cider.tasks/add-middleware -m cider.nrepl/wrap-classpath -m cider.nrepl/wrap-complete -m cider.nrepl/wrap-debug -m cider.nrepl/wrap-format -m cider.nrepl/wrap-info -m cider.nrepl/wrap-macroexpand -m cider.nrepl/wrap-ns -m cider.nrepl/wrap-out -m cider.nrepl/wrap-spec -m cider.nrepl/wrap-test -m cider.nrepl/wrap-trace -m cider.nrepl/wrap-undef -m refactor-nrepl.middleware/wrap-refactor -m iced.nrepl/wrap-iced -- $OPTIONS repl
            else
                boot -i "(require 'cider.tasks)" -d nrepl:0.6.0 -d refactor-nrepl:2.4.0 -d cider/cider-nrepl:0.21.1 -d iced-nrepl:0.4.1 -d cider/piggieback:0.4.0 -- cider.tasks/add-middleware -m cider.nrepl/wrap-classpath -m cider.nrepl/wrap-complete -m cider.nrepl/wrap-debug -m cider.nrepl/wrap-format -m cider.nrepl/wrap-info -m cider.nrepl/wrap-macroexpand -m cider.nrepl/wrap-ns -m cider.nrepl/wrap-out -m cider.nrepl/wrap-spec -m cider.nrepl/wrap-test -m cider.nrepl/wrap-trace -m cider.nrepl/wrap-undef -m refactor-nrepl.middleware/wrap-refactor -m iced.nrepl/wrap-iced -m cider.piggieback/wrap-cljs-repl -- $OPTIONS repl
            fi
        elif [ $IS_CLOJURE_CLI -eq 1 ]; then
            echo_info "Clojure CLI project is detected"
            if [ $IS_CLJS -eq 0 ]; then
                clojure $OPTIONS -Sdeps "{:deps {iced-repl {:local/root \"${PROJECT_DIR}\"}}}" -m iced-repl
            else
                clojure $OPTIONS -Sdeps "{:deps {iced-repl {:local/root \"${PROJECT_DIR}\"} cider/piggieback {:mvn/version \"0.4.0\"}}}" \
                    -m iced-repl 'with-cljs-middleware'
            fi
        elif [ $IS_SHADOW_CLJS -eq 1 ]; then
            echo_error 'Currently iced command does not support shadow-cljs.'
            echo 'Please see `:h vim-iced-manual-shadow-cljs` for manual setting up.'
            exit 1
        else
            echo_error 'Failed to detect clojure project'
            exit 1
        fi
        ;;
    "help")
        case "$2" in
            "repl")
                iced_repl_usage
                ;;
            *)
                iced_usage
                ;;
        esac
        exit 0
        ;;
    "version")
        echo "${VERSION}"
        ;;
    *)
        iced_usage
        exit 1
        ;;
esac

exit 0
